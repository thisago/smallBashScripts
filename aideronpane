#!/usr/bin/env bash

# This script captures the contents of the current tmux pane and opens a popup with Aider allowing you to chat about the pane contents.

# TODO: Remove-me
export AIDERONPANE_DIR=~/Documents/repos/aideronpane

# Check if AIDERONPANE_DIR is set
if ! test -n "$AIDERONPANE_DIR"; then
  echo "Set AIDERONPANE_DIR in your path for Aider history storage"
  exit 1
fi

# Check if the directory exists and is a Git repository
if [ ! -d "$AIDERONPANE_DIR" ] || [ ! -d "$AIDERONPANE_DIR/.git" ]; then
  echo "AIDERONPANE_DIR does not exist or is not a Git repository. Please check the path."
  exit 1
fi

# Check if needed commands are available
for cmd in tmux aider git; do
  if ! command -v "$cmd" &> /dev/null; then
    echo "Command '$cmd' not found. Please install it first."
    exit 1
  fi
done


# Get current pane id
PANE_ID=$(tmux display-message -p "#{pane_id}")

# Write the pane contents into a temporary file
PANE_CONTENTS_FILE=$(mktemp "$AIDERONPANE_DIR/pane_contents.XXXXXX.md")

echo "# Tmux Pane Contents" > "$PANE_CONTENTS_FILE"
echo "Use this file to chat with user about the contents of his tmux pane." >> "$PANE_CONTENTS_FILE"
echo '```' >> "$PANE_CONTENTS_FILE"
tmux capture-pane -p -t "$PANE_ID" >> "$PANE_CONTENTS_FILE"
echo '```' >> "$PANE_CONTENTS_FILE"
echo "User wants a quick summary of the contents of his tmux pane, so please provide a concise overview on the first response." >> "$PANE_CONTENTS_FILE"

# Open popup with the command
cd "$AIDERONPANE_DIR"
tmux new-window -n aideronpane "aider \"$PANE_CONTENTS_FILE\""

git add "$PANE_CONTENTS_FILE" && \
  git commit -m "chore(aideronpane): Add pane contents from $PANE_ID" &> /dev/null
